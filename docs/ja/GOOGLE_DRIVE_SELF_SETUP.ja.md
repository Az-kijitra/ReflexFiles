# Google Drive 自己設定ガイド（ユーザー所有 Google Cloud）
更新日: 2026-02-21

## 目的
ReflexFiles は GitHub 公開プロジェクトのため、共通の Google API 資格情報は配布しません。  
各ユーザーが自分の Google Cloud で設定し、ローカルでのみ利用します。

## 重要な前提（先に確認）
1. 現在の ReflexFiles は Google Drive 連携の段階実装中です。
2. `バックエンド種別` が `実 Google Drive API` の場合、`gdrive://root/my-drive` の一覧は実データを取得します。
3. `バックエンド種別` が `スタブ（テスト用仮想データ）` の場合、`gdrive://` はテストデータ表示です。
4. Google Drive ファイル本文の閲覧・編集系は段階的に実装中です（一覧取得が先行）。

## セキュリティルール（必須）
1. API キー、OAuth クライアント シークレット、トークンを GitHub に公開しない。
2. 資格情報入りの `.env` をコミットしない。
3. 実資格情報は Google Cloud と自分のローカル環境だけで管理する。

## 料金（重要）
1. Google Drive API 公式ドキュメントでは、Drive API 利用は「追加料金なし」とされています。
2. 同じく公式ドキュメントでは、リクエスト上限を超えても追加請求はされないとされています。
3. ただし、同じ Google Cloud プロジェクトで別の有料サービスを有効化すると、そちらの料金は発生し得ます。
4. そのため「Google Cloud 全体が常に無料」ではなく、「Drive API を適切に分離運用すれば無料で維持しやすい」が正確です。

## 無課金で運用するための実践ルール（推奨）
1. ReflexFiles 専用の Google Cloud プロジェクトを作る（他用途と分離）。
2. そのプロジェクトでは `Google Drive API` 以外を有効化しない。
3. クォータ増加申請（Quota increase）を行わない。
4. 請求先アカウントをリンクしている場合は、予算アラートを必ず設定する。
5. 定期的に Billing レポートで 0 円運用を確認する。
6. 「絶対に課金されたくない」場合は、請求先リンクを解除して運用する（Google Cloud 側仕様で使えない機能が出る場合あり）。

## 無課金チェック手順（毎月）
1. Google Cloud Console で対象プロジェクトを選ぶ。
2. `Billing` を開く。
3. 当月コストが `¥0`（または `$0`）であることを確認する。
4. 0 でない場合は、`API とサービス` で有効化 API を再確認し、Drive API 以外を停止する。

## 事前準備
1. Google アカウント
2. Google Cloud Console にアクセスできること
3. ReflexFiles 最新版（設定画面に Google Drive 項目が表示される版）

## 手順A: Google Cloud 側の設定
### 1. プロジェクトを作成・選択
1. Google Cloud Console を開く。
2. 画面上部の「プロジェクト名」表示をクリックする。
3. 「新しいプロジェクト」で `ReflexFiles Personal` など任意名のプロジェクトを作成する。
4. 作成後、そのプロジェクトを選択状態にする。

### 2. Google Auth Platform の初期設定
1. 左メニューの「Google Auth Platform」を開く。
2. 「概要」でアプリ情報を入力する。
3. 入力例:
   - アプリ名: `ReflexFiles Personal`
   - ユーザーサポートメール: 自分の Gmail
   - デベロッパー連絡先: 自分の Gmail
4. ユーザータイプは通常「外部」で問題ありません。

### 3. Google Drive API を有効化
1. 「API とサービス」→「ライブラリ」を開く。
2. `Google Drive API` を検索して有効化する。

### 4. OAuth 同意画面を設定
1. 「API とサービス」→「OAuth 同意画面」を開く。
2. 必須項目を入力して保存する。
3. 「テストユーザー」で Gmail が「不適格」と表示される場合:
   - プロジェクトのオーナー/編集者なら、そのアカウントは追加不要で利用できる場合があります。
   - まずそのまま認証を試し、失敗時のみ権限設定を見直してください。

### 5. OAuth クライアント ID を作成
1. 「API とサービス」→「認証情報」を開く。
2. 「認証情報を作成」→「OAuth クライアント ID」を選ぶ。
3. アプリケーションの種類は「デスクトップアプリ」を選ぶ。
4. 発行された値を控える:
   - クライアント ID（必須）
   - クライアント シークレット（任意。必要時のみ使用）

## 手順B: ReflexFiles 側の設定
### 1. 設定画面を開く
1. ReflexFiles を起動する。
2. 設定を開き、「詳細設定」内の Google Drive 認証ブロックを開く。

### 2. 入力項目
以下の日本語ラベルに入力します。

1. `OAuth クライアント ID`  
   - Google Cloud で発行されたクライアント ID
2. `OAuth クライアント シークレット（任意）`  
   - 通常は空欄  
   - `client_secret is missing` エラーが出たときのみ入力
   - 入力して認証が成功すると、`config.toml` ではなく OS の安全な資格情報ストアに保存される
3. `OAuth リダイレクト URI`  
   - 既定値: `http://127.0.0.1:45123/oauth2/callback`
   - Google 側と完全一致が必要

### 3. サインイン開始
1. `サインイン開始` を押す。
2. ブラウザが開くので Google ログインと同意を実行する。

### 4. コールバックURL取得（自動）
1. 同意後、ReflexFiles が `コールバック URL` を自動入力します。
2. 自動取得に失敗した場合のみ、ブラウザのアドレスバー URL 全体（`state=` と `code=` を含む）を手動で貼り付けます。

### 5. サインイン完了
1. ReflexFiles に戻る。
2. `コールバック URL` は自動入力値を確認する（空なら手動で貼り付ける）。
3. `アカウント ID（メールアドレス）` に利用中の Google メールアドレスを入力する。
4. `サインイン完了` を押す。
5. `Google Drive 認証セッションを更新しました。` と表示されれば成功です。
6. `認証フェーズ` が `認証済み` になっていることを確認します。
7. `バックエンド種別` が `スタブ（テスト用仮想データ）` の場合、`gdrive://` は実ファイルではなくテストデータ表示です。
8. 1 回認証に成功すると、次回起動後は保存済み資格情報を再利用し、`gdrive://` アクセス時に自動再接続されます。

## よくあるエラーと対処
1. `Google token 交換に失敗しました: client_secret is missing.`
   - `OAuth クライアント シークレット（任意）` にシークレットを入力して再実行。
2. `ERR_CONNECTION_REFUSED`（ブラウザ）
   - 想定動作です。アドレスバー URL を `コールバック URL` に貼り付けて続行。
3. `コールバックURLには state と code の両方が必要です。`
   - URL の一部ではなく全文を貼り付ける。
4. `redirect_uri_mismatch`
   - `OAuth リダイレクト URI` を Google 設定値と 1 文字違わず一致させる。
5. 認証成功後も Drive の実ファイルが見えない
   - 現段階はスタブ表示です。実データ一覧は未実装です。

## 公開前チェック（必須）
1. クライアント シークレットをコミットしていない。
2. トークン値をログ・スクリーンショット・PR本文に含めていない。
3. 公開ドキュメントには実値を載せず、例示値のみを使用している。

## 参考（公式）
- Google Drive API Usage limits / Pricing:
  - https://developers.google.com/drive/api/guides/limits
- Cloud Billing: プロジェクトの請求有効/無効の変更:
  - https://cloud.google.com/billing/docs/how-to/modify-project
- Cloud Billing: 予算とアラート:
  - https://cloud.google.com/billing/docs/how-to/budgets
